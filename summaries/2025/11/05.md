# Activity Summary for 11/5/2025

## 1:36:15 PM
The development log details significant changes across three files related to an "Air Ticket" feature within a Supabase CRM application.

**File-Specific Updates:**

*   **`h:\wamp64\www\supabase-crm\client-CRM-supabase\src\validation\schemas\FolderSchemas.js`**:
    *   **Initial Refinement (11/5/2025, 12:51:13 PM):** The `airTicketSchema` was fully activated and expanded. It now enforces a strict 5-character length for `ticketing_pnr`, introduces new nullable optional flight fields (e.g., `ticketing_number`, `gds_pnr`, `seat_no`), and adds required validations for `passenger_id`. The initial `ticketing_prices` schema was set as an array of objects with `desc`, `buy`, and `sell` as required.
    *   **Schema Mismatch & Correction Attempts (11/5/2025, 1:06:59 PM - 1:13:12 PM):** The validation for `ticketing_prices` underwent several iterations, initially attempting to validate `desc` and `buy` as arrays *within* each object of an array, which was an unusual structure. Critically, by **11/5/2025, 1:12:02 PM**, the schema for `ticketing_prices` was fundamentally changed from an array of objects to a single object containing `desc` and `buy` as arrays. This change better reflects the data structure handled by the UI components but notably removes validation for other pricing fields like `sell`, `vatcd1`, `comm2`, etc.

*   **`h:\wamp64\www\supabase-crm\client-CRM-supabase\src\pages\backend\Folder\Parts\Tabs\AirTicketModalBody.jsx`**:
    *   **Core Logic Implementation (11/5/2025, 12:51:59 PM):** This component was introduced to handle the user interface and logic for air ticket modals. It manages selected passengers, calculates various totals (buy, sell, payable, commission, VATs), and defines passenger selection columns. A significant part of this component is dedicated to managing `ticketing_prices`, treating it as an object where each price attribute (e.g., `desc`, `buy`, `sell`) is an array representing multiple pricing rows. It includes functions to add/remove price rows, update individual price fields, and perform real-time auto-calculations for `sell` and `payable` fields based on other pricing inputs.
    *   **Recurring Saves (11/5/2025, 12:52:42 PM - 1:34:44 PM):** Multiple log entries for this file show identical code, suggesting frequent saves during development without introducing new functional changes within these specific timestamps.

*   **`h:\wamp64\www\supabase-crm\client-CRM-supabase\src\pages\backend\Folder\Parts\Tabs\AirTicket.jsx`**:
    *   **Main Component & Supabase Integration (11/5/2025, 12:57:09 PM):** This file was created to manage the overall Air Ticket section. It integrates with Supabase for fetching, adding, editing, and deleting air ticket data, joining `passengers` and `vendors`. It utilizes Formik (`AirTicketAdd`, `AirTicketUpdate`) with `airTicketSchema` for form handling. Initial values for new tickets are set, and an `useEffect` hook prefills the `ticketing_pnr` from existing air segments when adding a new ticket. The component also calculates a `paymentSummary` of totals from the displayed air tickets.
    *   **Initial Value Adjustments (11/5/2025, 12:58:30 PM - 12:59:32 PM):** The `commonInitialValues` for `ticketing_prices` were first changed to an array of objects where each field (like `desc`, `buy`) was itself an array containing an empty string. Subsequently, this was simplified to an empty array `[]`, likely deferring the actual structure initialization to the `AirTicketModalBody` component's internal logic. `validateOnMount: true` was also added to the `AirTicketAdd` Formik configuration.

**Timestamps of Significant Changes:**

*   The most impactful changes occurred early in the sequence: `FolderSchemas.js` being activated and refined on **11/5/2025, 12:51:13 PM**, `AirTicketModalBody.jsx`'s initial complex pricing logic on **11/5/2025, 12:51:59 PM**, and `AirTicket.jsx`'s main component integration on **11/5/2025, 12:57:09 PM**.
*   Subsequent adjustments to `commonInitialValues` in `AirTicket.jsx` around **12:58 PM - 12:59 PM** reflect adaptations to the `ticketing_prices` data model.
*   The validation schema for `ticketing_prices` in `FolderSchemas.js` saw a critical structural change between **1:06:59 PM and 1:12:02 PM**, aiming to align with the component's data handling but potentially losing comprehensive validation for all pricing fields.

**Patterns or Recurring Elements:**

*   **Supabase and Formik/Yup Stack:** There's a consistent use of Supabase for data operations, Formik for form state management, and Yup for validation schemas across the relevant components.
*   **Complex Pricing Data Model:** A recurring theme is the complex `ticketing_prices` data structure, which is handled as an object containing arrays for individual price components (e.g., `desc: ['item1', 'item2']`, `buy: [100, 200]`) rather than a simple array of flat objects. This model influences both the UI component logic and the evolving validation schema.
*   **Modular UI Components:** The development splits functionality into distinct React components like `AirTicket` (main view) and `AirTicketModalBody` (modal content), promoting reusability and separation of concerns.
*   **Real-time Calculations:** The `AirTicketModalBody` actively performs client-side calculations to update `sell` and `payable` amounts as other pricing inputs change.
*   **Status/Loading Management:** States like `isLoading`, `btnLoading`, `loading` are used to manage UI feedback during asynchronous operations.

## 2:36:03 PM
The code changes primarily focus on the `AirTicket` feature within a Supabase CRM client, impacting both its validation schema and its UI component for adding/editing air tickets.

**File-specific updates and significant timestamps:**

**1. `h:\wamp64\www\supabase-crm\client-CRM-supabase\src\validation\schemas\FolderSchemas.js`**
   *   **11/5/2025, 12:51:13 PM:** The `airTicketSchema` was significantly revised.
      *   An old, commented-out version of `airTicketSchema` using `Yup.array().of(Yup.object().shape({...}))` for `prices` was present.
      *   The new `airTicketSchema` uses a different structure for `ticketing_prices`: it is `Yup.array().of(Yup.object().shape({...}))` with individual fields like `desc`, `buy`, `sell` directly required within each object.
      *   The `ticketing_pnr` validation was made stricter, requiring it to be a string, exactly 5 characters long, and mandatory.
      *   New optional fields were added, such as `ticketing_number`, `ticketing_atol`, `ticket_atol_tkt_issue`, `ticketing_cabin`, `gds_pnr`, `ffn_no`, `ticket_air_line_code`, `ticket_issue_date`, `seat_no`, `baggage_allowance`.
      *   `passenger_id` was added as a required number with a specific error message.
      *   An optional `notes` array of objects was added.
   *   **11/5/2025, 1:06:59 PM:** Modifications were made to the `ticketing_prices` schema within `airTicketSchema`. Specifically, `desc` and `buy` changed from direct `Yup.string().required()` to `Yup.array().of(Yup.string().required("Description required"))` and `Yup.array().of(Yup.number().typeError("Buy must be a number").required("Required"))` respectively. The `sell` field became a direct `Yup.number().typeError("Sell must be a number").required("Sell price is required")`. This seems to be an attempt to use arrays for `desc` and `buy` within each price object, which might be an incorrect interpretation for a single price entry, or a temporary change.
   *   **11/5/2025, 1:12:02 PM** and **1:13:12 PM:** The `ticketing_prices` schema in `airTicketSchema` was further simplified, making it a `yup.object` with `desc` and `buy` as arrays of required strings. The `sell` field and other price-related fields (vat, commission, payable) were removed from the `airTicketSchema` definition entirely in this version, which likely caused validation issues later.
   *   **11/5/2025, 1:43:52 PM:** The commented-out old `airTicketSchema` block was removed. The `airTicketSchema` was reverted to a state similar to the 12:51:13 PM timestamp, but with `ticketing_prices` defined as a `Yup.object` containing `desc` and `buy` as arrays of required strings, and crucially, *without* the `sell` field in the `Yup.object`. This is still an incomplete schema for `ticketing_prices` compared to the UI's calculation logic.
   *   **11/5/2025, 1:46:11 PM:** The `ticketing_prices` schema was updated to explicitly include `sell` as `Yup.array().of(Yup.string().required('Buy is required'))`, which appears to be a copy-paste error as it requires "Buy is required" for `sell`.

**2. `h:\wamp64\www\supabase-crm\client-CRM-supabase\src\pages\backend\Folder\Parts\Tabs\AirTicketModalBody.jsx`**
   *   **11/5/2025, 12:51:59 PM - 2:07:19 PM:** This file, `AirTicketModalBody.jsx`, underwent numerous identical changes throughout this period. The timestamps show repeated saving of seemingly the same content without any functional changes in the provided diffs.
      *   The component manages the UI for adding/editing air tickets, including passenger selection, a dynamic price table, and calculation of totals.
      *   It initializes `ticketing_prices` with a detailed object containing arrays for `desc`, `buy`, `vatcd1`, `buyvat`, `comm2`, `vatcd2`, `commvat`, `sell`, `vatcd3`, `sellvat`, `payable`, each initialized with `['']` or `['0']`.
      *   It contains logic for `addPriceRow` and `removePriceRow` to dynamically manage the price table rows.
      *   The `updatePriceField` function includes complex auto-calculation logic for `sell` and `payable` fields based on `buy`, `vatcd1`, `buyvat`, `comm2`, `vatcd2`, `commvat`, `vatcd3`, and `sellvat`.
      *   The `calculateTotals` function aggregates `totalBuy`, `totalSell`, `totalPayable`, `totalCommission`, `totalBuyVat`, and `totalSellVat` across all price rows.
      *   **Observation:** Despite multiple saves, the content of `AirTicketModalBody.jsx` seems consistent in the provided log snippets, suggesting minor, unlogged changes or frequent saves without significant code modification in the visible parts. The consistent presence of the detailed `ticketing_prices` object and its calculation logic highlights a potential mismatch with the frequently changing (and sometimes simplified) `airTicketSchema` in `FolderSchemas.js`.

**3. `h:\wamp64\www\supabase-crm\client-CRM-supabase\src\pages\backend\Folder\Parts\Tabs\AirTicket.jsx`**
   *   **11/5/2025, 12:57:09 PM:** This file, `AirTicket.jsx`, manages the main Air Ticket listing and the add/edit modals.
      *   It defines `commonInitialValues` for the Air Ticket form, which includes `ticketing_prices` as an array of a single object with many pricing fields (`desc`, `buy`, `vatcd1`, etc., all initialized to `''` or `'0'`).
      *   The `AirTicketAdd` Formik instance uses `airTicketSchema` for validation.
      *   It includes a `useEffect` to prefill `ticketing_pnr` from `airsegments` when the add modal opens, if the field is empty.
      *   The `AirTicketUpdate` Formik instance exists but initially lacks `validationSchema`.
      *   A `paymentSummary` `useMemo` hook calculates total buy, commission, sell, payable, buy VAT, and sell VAT from the `tableData`.
   *   **11/5/2025, 12:58:30 PM:** The `commonInitialValues` for `ticketing_prices` was changed from `[{ desc: '', buy: '', ... }]` to `[{ desc: [''], buy: [''], ... }]`, making the values for `desc` and `buy` arrays, aligning with the `AirTicketModalBody.jsx`'s initialization, but not with `FolderSchemas.js` at some points. This change reflects the UI expecting arrays for these price fields.
   *   **11/5/2025, 12:59:32 PM:** The `commonInitialValues` for `ticketing_prices` was simplified to an empty array `[]`. This contradicts the `AirTicketModalBody`'s initialization logic which expects a structured object or will initialize it.
   *   **11/5/2025, 1:42:37 PM:** The `AirTicketUpdate` Formik instance was updated to include `validationSchema: airTicketSchema, validateOnMount: true`, ensuring validation is applied to updates as well.

**Patterns and Recurring Elements:**

*   **Air Ticket Management:** All changes revolve around the "Air Ticket" feature, including data validation, UI logic for forms, and data fetching/persistence.
*   **Formik and Yup:** The application consistently uses Formik for form management and Yup for validation. `airTicketSchema` is a central piece for validating air ticket data.
*   **`ticketing_prices` Complexity:** There's a recurring pattern of complexity and inconsistency in how `ticketing_prices` is handled.
    *   The `AirTicketModalBody.jsx` component consistently expects `ticketing_prices` to be an object where each key (`desc`, `buy`, `sell`, `vatcd1`, etc.) holds an array of values, and it includes intricate auto-calculation logic for these fields.
    *   In contrast, `FolderSchemas.js` shows multiple attempts to define `ticketing_prices`, sometimes as an array of objects (where each object has `desc`, `buy`, `sell` as direct values), and other times as an object where `desc` and `buy` are arrays themselves. This indicates ongoing refinement or confusion about the exact structure of the `ticketing_prices` field, and a potential mismatch between the schema and the UI logic.
*   **Supabase Integration:** Supabase is used for data fetching, insertion, and updates (`supabase.from('air_tickets').select()...`, `insert([...])`, `update({...})`).
*   **Date Formatting:** `dayjs().format("YYYY-MM-DD")` is consistently used for date formatting when setting initial values or timestamps for created/updated dates.
*   **Toast Notifications:** `primereact/toast` and `showError`/`showSuccess` utilities are used for displaying user feedback.
*   **UI Component Reuse:** Standard UI components like `Button`, `SearchAutoComplete`, `DataTableList`, `MultipleNotes`, `Select`, `ModalCustom` are imported and used across related files.
*   **State Management:** `useState` and `useRef` hooks are heavily used for component-level state management, and `useMemo` for memoizing computed values (e.g., `passengerTableColumn`, `paymentSummary`).
*   **Minor Edits/Saves:** Multiple consecutive timestamps for `AirTicketModalBody.jsx` show identical code snippets, suggesting frequent saving with minimal or unlogged changes between each save. This could be due to small iterations, debugging, or automated save features.