# Activity Summary for 12/7/2025

## 4:18:38 PM
The code changes primarily focus on the receipt functionality within a Supabase CRM application, specifically for a `FolderReceipt` component and a related utility file `utilityFolderAndDeal.jsx`.

**File-Specific Updates:**

*   **`h:\wamp64\www\supabase-crm\client-CRM-supabase\src\pages\backend\Folder\Receipt\FolderReceipt.jsx`** (Multiple timestamps: 12/7/2025, from 11:26:59 AM to 4:09:34 PM):
    *   **Initial State and Hooks:** The component uses `useState` for managing various data points like `journalData`, `allJournalData`, `bankList`, `clientData`, `paxNo`, `journalReceipts`, `journalReceiptsVoided`, `itinerary`, and UI states like `openCreateReceiptModal`, `btnLoading`, `modalLoading`, `loading`, `pageLoading`, and `paymentType`. It leverages `useParams`, `useContextAuth`, and `useCompanyAndComUser` hooks.
    *   **Data Fetching:**
        *   `fetchJournal`: This `useCallback` function is central to fetching journal entries.
            *   Initially, it fetched `client_id` from the `folders` table, then used this `clientId` to fetch `journals` filtered by `folder_id` and `j_status='confirm'`.
            *   Around `12:07:40 PM`, the `fetchJournal` query was modified to filter journals by `j_entry_summary='sell'` and `j_debit is not null`, removing the `client_id` filter from the direct journal fetch.
            *   By `12:22:34 PM`, a new state `allJournalData` was introduced to store all fetched journals, and `journalData` was then filtered from `allJournalData` based on `j_entry_summary`, `j_debit`, and `j_status`. The `clientId` filter was re-added.
            *   Further refinements (around `12:38:31 PM` to `12:44:03 PM`) to the `fetchJournal` logic were made to ensure correct filtering when fetching journal entries, specifically grouping them by `j_uid` and prioritizing 'receipt' status entries over 'confirm' status 'sell' entries. This involved using `reduce` and `map` to process the data.
            *   At `3:37:16 PM`, the `fetchJournal` logic was slightly refactored into two separate `useCallback` functions: `fetchClient` (to get `client_id` first) and `fetchJournal` (to fetch journals using the obtained `clientId`), addressing a potential issue where `clientId` might not be immediately available to `fetchJournal`. However, this change was reverted or combined back by `3:39:49 PM`, with `fetchJournal` handling both `client_id` retrieval and subsequent journal fetching and filtering.
    *   **Receipt Number Generation:** `fetchReceiptNo` is a `useCallback` function to get the next sequential receipt number from Supabase journals.
    *   **Form Management:**
        *   `receiptPrices` (Formik instance) is used for `is_invoice_price`.
        *   `receiptFormik` (main Formik instance) handles payment details. Its `initialValues` are memoized based on `journalData`, and `validationSchema` is dynamically generated based on `paymentType`.
        *   The `onSubmit` function in `receiptFormik` outlines the process of generating a receipt number, building debit and credit rows for journal insertions, and tracking inserted IDs for potential rollbacks.
    *   **Validation Schema:** `getValidationSchema` defines Yup-based validation rules for various payment methods (e.g., requiring bank for non-cash payments, and specific card details for credit card payments). The `card_no` validation regex was updated from `/^\d{4}$/` to `/^\d{5}$/` at `3:27:17 PM`, then reverted back to `/^\d{4}$/` by `3:32:53 PM`.
    *   **UI Components:** Imports `Collapse` and `Panel` from `antd` at `3:52:54 PM` and `4:01:44 PM`, suggesting an intent to organize the receipt display, although the provided code snippets don't show the usage.
    *   **Logging:** Numerous `console.log` statements are present throughout, indicating active debugging during development.
    *   **Toast:** Integration of `primereact/toast` and custom `showSuccess` toast.

*   **`h:\wamp64\www\supabase-crm\client-CRM-supabase\src\util\utilityFolderAndDeal.jsx`** (Multiple timestamps: 12/7/2025, from 11:29:48 AM to 1:57:08 PM):
    *   **`isFieldInvalid`:** A helper function to check Formik field validity.
    *   **`handleFolderLock`:** An asynchronous function to update folder session lock status in Supabase.
    *   **`realtimeItineraryData`:** Manages Supabase real-time subscriptions for various itinerary-related tables (`airsegments`, `air_tickets`, `accommodations`, `visas`, `car_hires`, `tours`, `insurances`, `transfers`, `extras`, `journals`). It notifies listeners on data changes and provides an unsubscribe mechanism.
    *   **`fetchItineraryData`:** Fetches itinerary data (or just counts) from multiple Supabase tables in parallel, handling success and error callbacks.
    *   **`calculateItineraryTotalPrice`:** Calculates total pricing details for an itinerary based on various item types and passenger count.
    *   **`getProductDue` and `getProductPaid`:** These utility functions are defined and consistently used, indicating a modular approach to calculating financial aspects of products/journal entries.
    *   **No significant structural or functional changes between the timestamps; mostly consistent content.**

*   **`h:\wamp64\www\supabase-crm\client-CRM-supabase\src\pages\backend\Folder\Receipt\ReceiptBody.jsx`** (Multiple timestamps: 12/7/2025, from 12:50:35 PM to 3:31:05 PM):
    *   **Component Structure:** Renders a receipt form with sections for date, a table displaying journal entries with payment details (Total Payable, Payment received, Payment input, Payment Due), and fields for payment method, reference, currency, exchange rate, and bank. A dedicated section for Credit Card details appears conditionally.
    *   **Data Display and Interaction:** It iterates through `formik.values.journalPayments` to display and allow input for individual payments. It uses `getProductDue` and `getProductPaid` from `utilityFolderAndDeal` to calculate and display financial summaries.
    *   **Input Fields:** Utilizes Ant Design's `DatePicker` and `Select` components, along with standard HTML inputs.
    *   **Conditional Rendering:** The "Bank" field and "Credit Card Details" section are conditionally rendered based on the selected `paymentType`.
    *   **Card Number Validation:** The `card_no` input's `onChange` handler was updated at `3:31:05 PM` to specifically remove non-digit characters and limit the input to 4 digits, aligning with the `FolderReceipt.jsx` validation schema.
    *   **Debugging:** Includes `console.log` statements for `due` and `allJournalData`.
    *   **Prop Updates:** The `getProductDue` and `getProductPaid` calls were updated at `1:04:16 PM` to pass `allJournalData` as a third argument, indicating a change in how these utility functions access the complete journal data.

**Patterns and Recurring Elements:**

*   **Supabase Integration:** Both `FolderReceipt.jsx` and `utilityFolderAndDeal.jsx` heavily interact with Supabase for data fetching and potentially updates. `supabase` is consistently imported and used.
*   **Formik and Yup:** Formik is the primary library for form management and validation, coupled with Yup for schema-based validation, indicating a standardized approach to form handling.
*   **State Management:** `useState`, `useCallback`, and `useMemo` hooks are extensively used for managing component state, memoizing functions, and optimizing performance in React components.
*   **Modular Design:** The separation of UI (`ReceiptBody.jsx`) from complex logic and data fetching (`FolderReceipt.jsx`) and utility functions (`utilityFolderAndDeal.jsx`) is evident.
*   **Logging:** Frequent `console.log` statements suggest an ongoing development and debugging process.
*   **Consistent Styling:** Class names like `form__control`, `input-group`, `form-error`, `text-danger` suggest a consistent UI/UX framework.
*   **Date Handling:** `dayjs` is used for date manipulation.
*   **Financial Calculations:** The presence and evolution of `getProductDue` and `getProductPaid` indicate a focus on accurate financial tracking and display.
*   **Conditional UI:** Conditional rendering based on `paymentType` is a recurring pattern for handling different payment methods.