# Activity Summary for 12/28/2025

## 2:28:05 PM
The `h:\wamp64\www\supabase-crm\client-CRM-supabase\src\components\Backend\Interface\BookingDetails\parts\BookingDetailsButtons.jsx` file underwent several iterations of changes throughout the day, primarily focused on the `AddToFolder` asynchronous function, which is responsible for creating a new "folder" entry in a CRM system and populating it with booking details from an external booking.

**File: `BookingDetailsButtons.jsx`**

*   **12/28/2025, 12:13:41 PM**: The initial state of the `AddToFolder` function was to check if a booking already exists in a folder. It included preparatory logic for extracting booking data (contact details, flights, hotels, transfers, passengers, price, air segments) and defining how different booking services map to CRM folder options. Crucially, the core logic for *creating* the folder, inserting passengers, and air segments, and generating tickets was heavily commented out.
*   **12/28/2025, 12:42:01 PM - 1:31:52 PM**: Multiple saves occurred during this period without any discernible functional code changes. The large block of commented-out logic remained untouched.
*   **12/28/2025, 1:39:11 PM**: This was a significant update. The previously commented-out block of code within the `if (folderData.length === 0)` condition was uncommented, activating the logic for:
    *   Creating a new folder record in the `folders` Supabase table with details like `folder_uid`, `created_by`, `company_id`, `booking_reference`, and travel options.
    *   Inserting passenger data (title, first name, last name, DOB, passport details, etc.) into the `passengers` table.
    *   Inserting air segment details (airline, flight number, departure/arrival cities, status) into the `airsegments` table.
    *   A new comprehensive section for generating and inserting "air tickets" was introduced. This involved complex pricing calculations (`buildPricePoolByType`, `buildPassengerPricing`) to determine buy, sell, and commission totals per passenger, and then inserting these structured ticket objects into the `airtickets` table.
*   **12/28/2025, 1:39:55 PM**: A refinement was made to ensure consistency. The `passengerData` variable, intended to hold the IDs of newly created passengers, was correctly assigned the result from the `passengers` table insertion. The `allTickets` mapping was updated to use this `passengerData` and reference `pax.id` for `passenger_id`, aligning ticket creation with the newly inserted passenger records.
*   **12/28/2025, 1:42:01 PM**: The target Supabase table for tickets was renamed from `airtickets` to `air_tickets`. Additionally, a `created_at` timestamp was added to the ticket object being inserted.
*   **12/28/2025, 1:44:18 PM**: The `uid` function call for `ticket_uid` was simplified, removing the explicit `len: 8` option.
*   **12/28/2025, 1:57:36 PM**: Several new fields (`vendor_name`, `vendor_id`, `airline_code`, `ticketing_bsp`, `is_client_card`, `ticketing_conf_no`, `ticketing_atol`, `ticket_atol_tkt_issue`, `ticketing_cabin`) were added to the `allTickets` object during insertion, indicating an expansion of the air ticket schema.
*   **12/28/2025, 2:03:51 PM**: No functional changes were observed.
*   **12/28/2025, 2:08:25 PM**: The `buildPassengerPricing` and `allTickets` mapping functions were updated to explicitly use the `passengerData` (which contains the newly inserted passenger records) instead of the original `passengers` array from `flights[0]`. This ensures that ticket pricing is correctly linked to the persisted passenger data.
*   **12/28/2025, 2:08:34 PM**: A critical correction was made in the `allTickets` mapping: `passenger_id` was changed from `pax.flight_passenger_id` to `pax.id`, reflecting that the `passengerData` now contains the Supabase-generated IDs for passengers. The `paxTypeMap` lookup was also updated to use `pax.pax_type.toLowerCase()`.
*   **12/28/2025, 2:11:30 PM - 2:14:31 PM**: No functional changes were observed.
*   **12/28/2025, 2:14:56 PM**: A new import `paxType` was added from `../../../../../constants/Settings/Folder`, and a debugging `console.log("Pricing for passenger", pax);` statement was inserted.

**File: `AirTicket.jsx`**

*   **12/28/2025, 1:53:17 PM**: This file, responsible for managing Air Tickets within a folder in the backend interface, was introduced or significantly updated. It imports numerous components and hooks, sets up state for managing ticket data, modals (add, edit, delete, email), and loading states.
    *   It defines `fetchAirTicketData` to retrieve air tickets (both normal and re-issued) from the `air_tickets` table, including joining with `passengers` and `vendors`.
    *   `loadPassAndNotes` fetches notes for the invoice.
    *   Formik instances (`AirTicketAdd`, `AirTicketUpdate`) are used for form handling, validation, and submitting data to Supabase for insertion and updates into the `air_tickets` table.
    *   It includes logic to prefill PNRs and handle soft deletion of tickets.
    *   An `ActionColumnTemplate` is defined for the data table, providing actions like edit, delete, email, and PDF download (using `AirTicketPDF`).

**File: `AirTicketModalBody.jsx`**

*   **12/28/2025, 2:20:48 PM**: This component defines the UI and logic for adding or editing an air ticket within a modal.
    *   It manages local state for `totals` related to ticketing (buy, sell, payable, commission, VATs) and `selectedPassengers` for associating a ticket with a passenger.
    *   A `passengerTableColumn` is defined to display a list of passengers, allowing the user to select one via a radio button.
    *   A critical feature is the dynamic pricing table, managed by `initializePrices`, `getRowCount`, `addPriceRow`, and `removePriceRow`.
    *   `updatePriceField` includes auto-calculation logic: when buy, VATs, or commission fields change, the `sell` price is automatically updated, and when sell or sell-related VATs change, the `payable` amount is updated.
    *   `calculateTotals` aggregates all row-level pricing into overall totals.
*   **12/28/2025, 2:21:11 PM - 2:24:32 PM**: Multiple saves occurred with no functional changes.
*   **12/28/2025, 2:25:08 PM**: A debugging `console.log("Calculating totals...", currentPrices);` was added inside `calculateTotals`.
*   **12/28/2025, 2:26:35 PM**: A minor safety change to `currentPrices.buy?.length` was made in `calculateTotals`.

**Key Patterns and Recurring Elements:**

*   **Supabase Interaction**: All files extensively use Supabase for database operations (insert, select, update) across multiple tables (`folders`, `passengers`, `airsegments`, `air_tickets`).
*   **Data Consistency**: There is a clear effort to ensure data consistency, particularly between newly created passenger records and the tickets linked to them. The repeated adjustments to `passengerData` and `pax.id` in `BookingDetailsButtons.jsx` highlight this.
*   **Complex Pricing Logic**: Both `BookingDetailsButtons.jsx` (for automated ticket generation) and `AirTicketModalBody.jsx` (for manual input) handle detailed pricing structures including buy, sell, commission, and various VAT components, along with auto-calculation. This structure often involves arrays for each price component to support multiple line items.
*   **Date Handling**: `dayjs` is consistently used for parsing and formatting dates across different parts of the application.
*   **Unique Identifiers**: The `uid` utility is used for generating unique IDs for folders and tickets, indicating a common pattern for generating primary keys or unique references.
*   **Component-based UI**: The application follows a component-based architecture, with specialized components like `BookingDetailsButtons`, `AirTicket`, and `AirTicketModalBody` handling specific parts of the UI and business logic.
*   **Active Development/Debugging**: The presence of numerous `console.log` statements and frequent saves with minor or no functional changes suggest an active development phase, likely involving debugging and iterative refinement of the new "Add to Folder" and "Air Ticket" features.
*   **Modular Utility Functions**: Imports like `utilityFunction`, `SupabaseClient`, and constants from `Settings/Folder` show a structured approach to common functionalities.

## 3:34:07 PM
The changes primarily revolve around the backend interface for booking details and air ticket management, specifically the process of adding booking information to a "folder" system and managing air tickets within that folder.

### File-Specific Updates:

*   **`h:\wamp64\www\supabase-crm\client-CRM-supabase\src\components\Backend\Interface\BookingDetails\parts\BookingDetailsButtons.jsx`**
    *   **Initial State (12/28/2025, 12:13:41 PM to 1:31:52 PM):** The component `BookingDetailsButtons.jsx` contained a large block of commented-out code within the `AddToFolder` function. This commented code outlined the logic for creating a new folder, inserting passenger details, air segment details, and initiating ticket pricing into Supabase. It included helper functions for date parsing, service mapping, and initial price structure calculations.
    *   **Uncommenting and Core Logic Activation (12/28/2025, 1:39:11 PM):** The major change was the uncommenting of the entire block of code responsible for creating a new folder in Supabase (`folders` table), populating it with initial data, then inserting passengers (`passengers` table), air segments (`airsegments` table), and finally air tickets (`airtickets` table). The `buildPassengerPricing` logic was fully implemented to handle ticket pricing based on passenger types.
    *   **Refinement of Passenger and Ticket Data (12/28/2025, 1:39:55 PM - 2:14:31 PM):**
        *   The `passengerData` variable was correctly populated with the result of the `passengers` table insertion, ensuring subsequent ticket creation used the newly generated passenger IDs.
        *   Date formats for `ticket_issue_date` and `created_at` were standardized to "YYYY-MM-DD".
        *   The Supabase table name for tickets was updated from `'airtickets'` to `'air_tickets'`.
        *   `passenger_id` for tickets was updated to use the `id` field from the created passenger records (`pax.id`) instead of `pax.flight_passenger_id`.
        *   The `ticketing_number` for `allTickets` was changed to `pax.eticket_number`.
    *   **Expanded Ticket Data Structure (12/28/2025, 1:57:36 PM):** Additional fields such as `vendor_name`, `vendor_id`, `airline_code`, `ticketing_bsp`, `is_client_card`, `ticketing_conf_no`, `ticketing_atol`, `ticket_atol_tkt_issue`, and `ticketing_cabin` were added to the ticket creation object, indicating a more detailed schema for air ticket records.
    *   **Price Calculation Refactoring (12/28/2025, 2:14:56 PM):** The `buildPassengerPricing` function underwent a significant refactoring. It now returns individual pricing components (buy, various VATs, commission, sell, payable, markup) rather than nested `totals` objects. The `ticketing_payable`, `ticketing_total_buy`, `ticketing_total_sell`, and `ticketing_comission` fields in the `allTickets` object were commented out, suggesting that these totals might now be derived directly from the structured `ticketing_prices` JSONB column.

*   **`h:\wamp64\www\supabase-crm\client-CRM-supabase\src\pages\backend\Folder\Parts\Tabs\AirTicket.jsx`**
    *   **Core Functionality (12/28/2025, 1:53:17 PM):** This component manages the display, addition, editing, and deletion of air tickets within a folder. It integrates with `AirTicketModalBody` for form input and `AirTicketPDF` for generating downloadable PDFs. It uses `useFormik` for `AirTicketAdd` and `AirTicketUpdate` forms, fetches air ticket, re-issue ticket, and company data from Supabase, and pre-fills PNRs from air segments. It also defines actions like editing, deleting, emailing, and downloading PDFs for each ticket.

*   **`h:\wamp64\www\supabase-crm\client-CRM-supabase\src\pages\backend\Folder\Parts\Tabs\AirTicketModalBody.jsx`**
    *   **Dynamic Price Input and Calculation (12/28/2025, 2:20:48 PM - 2:39:46 PM):** This component is responsible for the user interface and logic within the modal for adding/editing air tickets. It includes:
        *   State management for `totals` (total buy, sell, payable, commission, VATs).
        *   A table for passenger selection using radio buttons.
        *   Functions (`initializePrices`, `addPriceRow`, `removePriceRow`, `updatePriceField`, `calculateTotals`) to dynamically manage multiple pricing rows.
        *   Automatic calculation of `sell` price (buy + various VATs + commission) and `payable` price (sell + sales VATs) upon changes to input fields.
        *   The `calculateTotals` function sums up the individual pricing rows to provide overall totals.
    *   **Debugging Improvements:** Multiple `console.log` statements were added across various timestamps (e.g., 2:25:08 PM, 2:30:50 PM, 2:39:06 PM, 2:39:46 PM) to trace price initialization and calculation logic.
    *   **Safer Property Access (12/28/2025, 2:22:19 PM, 2:26:35 PM, 2:27:42 PM):** Optional chaining (`?.`) was introduced for safer access to nested properties like `formik.values?.ticketing_prices` and `currentPrices.buy?.length`.

### Timestamps of Significant Changes:

*   **12/28/2025, 1:39:11 PM:** Major activation of the "Add to Folder" functionality in `BookingDetailsButtons.jsx`, enabling the creation of folder, passenger, air segment, and air ticket records in Supabase.
*   **12/28/2025, 1:57:36 PM:** Expansion of the air ticket data model in `BookingDetailsButtons.jsx` to include more detailed financial and airline-specific information.
*   **12/28/2025, 2:14:56 PM:** Significant refactoring of the price calculation and storage mechanism within `BookingDetailsButtons.jsx`, moving towards a more granular representation of ticket pricing.
*   **12/28/2025, 2:20:48 PM:** Introduction of the `AirTicketModalBody.jsx` component, showcasing a complex, dynamic pricing table with auto-calculation logic for air tickets.

### Patterns or Recurring Elements:

*   **Supabase Integration:** All modified files extensively use the Supabase client for database interactions (inserting, selecting, updating data in tables like `folders`, `passengers`, `airsegments`, `air_tickets`).
*   **Date Management with Dayjs:** The `dayjs` library is consistently used for formatting and parsing date strings (e.g., `dayjs().format("YYYY-MM-DD")`).
*   **Form Management with Formik:** `useFormik` is a central tool for handling form state, validation, and submission, particularly evident in `AirTicket.jsx` and `AirTicketModalBody.jsx`.
*   **Dynamic UI and Calculations:** There's a strong pattern of dynamic UI elements (like adding/removing price rows in `AirTicketModalBody.jsx`) coupled with real-time calculations to ensure data consistency.
*   **Debugging via `console.log`:** Frequent use of `console.log` statements suggests ongoing development and debugging efforts, especially around data structures and calculation flows.
*   **Modularity:** The application is structured into components (e.g., `BookingDetailsButtons`, `AirTicket`, `AirTicketModalBody`) with distinct responsibilities, using props to pass data and functions.
*   **Constants and Utility Functions:** Reliance on shared constants (e.g., `services`, `paxType`) and utility functions (e.g., `uid`, `formatNumber`, `showError`) from `constants/Settings/Folder` and `util/utilityFunction`.